name: ğŸ¤– ActualizaciÃ³n AutomÃ¡tica Dashboard

on:
  schedule:
    # Ejecutar cada 6 horas
    - cron: '0 */6 * * *'
  workflow_dispatch: # Permitir ejecuciÃ³n manual

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        pip install requests
    
    - name: ğŸ”„ Ejecutar script paralelo
      run: |
        python3 dashboard_paralelo.py
    
    - name: ğŸ“Š Verificar datos generados
      run: |
        if [ -f "docs/dashboard_data.json" ]; then
          echo "âœ… Archivo dashboard_data.json generado"
          cat docs/dashboard_data.json | head -20
        else
          echo "âŒ Error: No se generÃ³ dashboard_data.json"
          exit 1
        fi
    
    - name: ğŸ“¤ Commit y Push automÃ¡tico
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add docs/dashboard_data.json
        
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No hay cambios para commitear"
        else
          git commit -m "ğŸ¤– ActualizaciÃ³n automÃ¡tica dashboard - $(date '+%Y-%m-%d %H:%M:%S')"
          git push origin main
          echo "âœ… Dashboard actualizado en GitHub Pages"
        fi
    
    - name: ğŸŒ Verificar deployment
      run: |
        echo "ğŸŒ Dashboard disponible en:"
        echo "https://ceo-exltk.github.io/descarga-sentencias-pjud/"
        echo ""
        echo "ğŸ“Š Datos actualizados:"
        echo "- Total real: $(jq -r '.resumen.total_real' docs/dashboard_data.json | numfmt --to=si)"
        echo "- Total descargado: $(jq -r '.resumen.total_descargado' docs/dashboard_data.json | numfmt --to=si)"
        echo "- Completitud: $(jq -r '.resumen.completitud_general' docs/dashboard_data.json)%"
