name: "Descarga Diaria AutomÃ¡tica"

on:
  schedule:
    # Ejecutar todos los dÃ­as a las 6:00 AM (UTC-3 = 9:00 AM UTC)
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      fecha_especifica:
        description: 'Fecha especÃ­fica a descargar (YYYY-MM-DD) - Dejar vacÃ­o para ayer'
        required: false
        type: string

jobs:
  descargar-sentencias-diarias:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Timeout de 1 hora
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          pip install requests
          echo "ğŸ“¦ Dependencias instaladas"
      
      - name: Determinar fecha de descarga
        id: fecha
        run: |
          if [ -n "${{ github.event.inputs.fecha_especifica }}" ]; then
            echo "fecha=${{ github.event.inputs.fecha_especifica }}" >> $GITHUB_OUTPUT
            echo "ğŸ“… Usando fecha especÃ­fica: ${{ github.event.inputs.fecha_especifica }}"
          else
            # Calcular fecha de ayer (UTC-3)
            FECHA_AYER=$(date -d "yesterday" +%Y-%m-%d)
            echo "fecha=$FECHA_AYER" >> $GITHUB_OUTPUT
            echo "ğŸ“… Descargando sentencias de ayer: $FECHA_AYER"
          fi
      
      - name: Descargar sentencias del dÃ­a
        run: |
          echo "ğŸ“… Descargando sentencias del dÃ­a: ${{ steps.fecha.outputs.fecha }}"
          python3 descargar_sentencias_api.py ${{ steps.fecha.outputs.fecha }} ${{ steps.fecha.outputs.fecha }}
      
      - name: Preparar archivos para Supabase
        run: |
          echo "ğŸ”„ Preparando archivos para ingesta en Supabase..."
          python3 preparar_para_supabase.py output/descarga_api
      
      - name: Cargar a Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "ğŸš€ Cargando datos a Supabase..."
          if [ -f "output/descarga_api/sentencias_para_supabase.json" ]; then
            python3 cargar_a_supabase.py \
              output/descarga_api/sentencias_para_supabase.json \
              $SUPABASE_URL \
              $SUPABASE_KEY
            echo "âœ… Datos cargados exitosamente a Supabase"
          else
            echo "âŒ Archivo de sentencias no encontrado"
            exit 1
          fi
      
      - name: Crear resumen
        run: |
          echo "ğŸ“Š Creando resumen de descarga..."
          echo "Fecha: ${{ steps.fecha.outputs.fecha }}" > descarga_resumen.txt
          echo "Timestamp: $(date)" >> descarga_resumen.txt
          echo "Tipo: Descarga automÃ¡tica diaria" >> descarga_resumen.txt
          echo "Cargado a Supabase: âœ… SÃ­" >> descarga_resumen.txt
          echo "Archivos generados:" >> descarga_resumen.txt
          find output/ -name "*.json" | wc -l >> descarga_resumen.txt
          echo "Total de archivos JSON generados" >> descarga_resumen.txt
          
          echo "" >> descarga_resumen.txt
          echo "=== ESTADÃSTICAS SUPABASE ===" >> descarga_resumen.txt
          echo "âœ… Datos cargados automÃ¡ticamente" >> descarga_resumen.txt
          echo "ğŸ”— URL: ${{ secrets.SUPABASE_URL }}" >> descarga_resumen.txt
          echo "ğŸ“… PrÃ³xima ejecuciÃ³n: MaÃ±ana a las 6:00 AM (UTC-3)" >> descarga_resumen.txt
      
      - name: Upload resultados
        uses: actions/upload-artifact@v4
        with:
          name: sentencias-diarias-${{ steps.fecha.outputs.fecha }}
          path: |
            output/
            descarga_resumen.txt
          retention-days: 7  # Mantener solo 7 dÃ­as
      
      - name: Mostrar resumen final
        run: |
          echo "âœ… Descarga diaria completada para: ${{ steps.fecha.outputs.fecha }}"
          echo "ğŸ“ Archivos generados:"
          find output/ -name "*.json" | head -5
          echo "..."
          echo "ğŸ“Š Total de archivos: $(find output/ -name "*.json" | wc -l)"
          echo "ğŸš€ Datos cargados automÃ¡ticamente a Supabase"
          echo "â° PrÃ³xima ejecuciÃ³n: MaÃ±ana a las 6:00 AM (UTC-3)"

  # Job de retry en caso de fallo
  retry-on-failure:
    runs-on: ubuntu-latest
    needs: descargar-sentencias-diarias
    if: failure()
    timeout-minutes: 30
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          pip install requests
          echo "ğŸ“¦ Dependencias instaladas (retry)"
      
      - name: Determinar fecha de descarga (retry)
        id: fecha_retry
        run: |
          if [ -n "${{ github.event.inputs.fecha_especifica }}" ]; then
            echo "fecha=${{ github.event.inputs.fecha_especifica }}" >> $GITHUB_OUTPUT
          else
            FECHA_AYER=$(date -d "yesterday" +%Y-%m-%d)
            echo "fecha=$FECHA_AYER" >> $GITHUB_OUTPUT
          fi
          echo "ğŸ”„ RETRY: Descargando sentencias del dÃ­a: ${{ steps.fecha_retry.outputs.fecha }}"
      
      - name: Descargar sentencias (retry)
        run: |
          echo "ğŸ”„ RETRY: Descargando sentencias del dÃ­a: ${{ steps.fecha_retry.outputs.fecha }}"
          python3 descargar_sentencias_api.py ${{ steps.fecha_retry.outputs.fecha }} ${{ steps.fecha_retry.outputs.fecha }}
      
      - name: Preparar archivos para Supabase (retry)
        run: |
          echo "ğŸ”„ RETRY: Preparando archivos para ingesta en Supabase..."
          python3 preparar_para_supabase.py output/descarga_api
      
      - name: Cargar a Supabase (retry)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "ğŸ”„ RETRY: Cargando datos a Supabase..."
          if [ -f "output/descarga_api/sentencias_para_supabase.json" ]; then
            python3 cargar_a_supabase.py \
              output/descarga_api/sentencias_para_supabase.json \
              $SUPABASE_URL \
              $SUPABASE_KEY
            echo "âœ… RETRY: Datos cargados exitosamente a Supabase"
          else
            echo "âŒ RETRY: Archivo de sentencias no encontrado"
            exit 1
          fi
      
      - name: Crear resumen (retry)
        run: |
          echo "ğŸ“Š Creando resumen de descarga (RETRY)..."
          echo "Fecha: ${{ steps.fecha_retry.outputs.fecha }}" > descarga_resumen_retry.txt
          echo "Timestamp: $(date)" >> descarga_resumen_retry.txt
          echo "Tipo: Descarga automÃ¡tica diaria (RETRY)" >> descarga_resumen_retry.txt
          echo "Cargado a Supabase: âœ… SÃ­" >> descarga_resumen_retry.txt
          echo "Archivos generados:" >> descarga_resumen_retry.txt
          find output/ -name "*.json" | wc -l >> descarga_resumen_retry.txt
          echo "Total de archivos JSON generados" >> descarga_resumen_retry.txt
      
      - name: Upload resultados (retry)
        uses: actions/upload-artifact@v4
        with:
          name: sentencias-diarias-retry-${{ steps.fecha_retry.outputs.fecha }}
          path: |
            output/
            descarga_resumen_retry.txt
          retention-days: 7
      
      - name: Mostrar resumen final (retry)
        run: |
          echo "âœ… RETRY: Descarga diaria completada para: ${{ steps.fecha_retry.outputs.fecha }}"
          echo "ğŸ“ Archivos generados:"
          find output/ -name "*.json" | head -5
          echo "..."
          echo "ğŸ“Š Total de archivos: $(find output/ -name "*.json" | wc -l)"
          echo "ğŸš€ Datos cargados automÃ¡ticamente a Supabase"
