name: ğŸ” Obtener Totales Reales PJUD

on:
  workflow_dispatch:  # Permite ejecuciÃ³n manual
  schedule:
    - cron: '0 6 * * *'  # Ejecutar diariamente a las 6 AM UTC
  push:
    paths:
      - 'scripts/cloud/obtener_totales_reales_cloud.py'

jobs:
  obtener-totales:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: ğŸ” Obtener totales del PJUD (reales o estimados)
      run: |
        echo "ğŸš€ INICIANDO CONSULTA DE TOTALES"
        echo "=================================="
        echo "â° Timestamp: $(date)"
        echo "ğŸŒ IP del runner: $(curl -s https://httpbin.org/ip | jq -r '.origin')"
        echo ""
        
        # Intentar obtener totales reales primero
        echo "ğŸ” Intentando obtener totales reales de la API..."
        python scripts/cloud/obtener_totales_reales_cloud.py
        
        # Si falla, usar estimaciones histÃ³ricas
        if [ $? -ne 0 ] || [ ! -f totales_reales_cloud_*.json ]; then
          echo ""
          echo "âš ï¸ API del PJUD bloqueada - Usando estimaciones histÃ³ricas"
          echo "ğŸ“Š Generando totales basados en anÃ¡lisis de patrones..."
          python scripts/cloud/obtener_totales_estimados.py
        fi
        
    - name: ğŸ“Š Procesar resultados
      run: |
        echo "ğŸ“Š PROCESANDO RESULTADOS"
        echo "======================="
        
        # Buscar el archivo mÃ¡s reciente de totales (reales o estimados)
        LATEST_FILE=$(ls -t totales_*_cloud_*.json 2>/dev/null | head -n 1)
        
        if [ -f "$LATEST_FILE" ]; then
          echo "âœ… Archivo encontrado: $LATEST_FILE"
          
          # Mostrar resumen
          echo ""
          echo "ğŸ“ˆ RESUMEN DE TOTALES:"
          echo "====================="
          
          # Verificar si es archivo de estimaciones o reales
          if [[ "$LATEST_FILE" == *"estimados"* ]]; then
            echo "ğŸ“Š Usando estimaciones histÃ³ricas (API bloqueada)"
            jq -r '.totales_por_tribunal | to_entries[] | "\(.key): \(.value)"' "$LATEST_FILE"
          else
            echo "ğŸ” Usando totales reales de la API"
            jq -r '.totales_por_tribunal | to_entries[] | "\(.key): \(.value)"' "$LATEST_FILE"
          fi
          
          TOTAL_GENERAL=$(jq -r '.total_general' "$LATEST_FILE")
          echo "Total General: $TOTAL_GENERAL"
          
        else
          echo "âŒ No se encontrÃ³ archivo de resultados"
          exit 1
        fi
        
    - name: ğŸ“¤ Subir resultados a GitHub Pages
      run: |
        echo "ğŸ“¤ SUBIENDO RESULTADOS A GITHUB PAGES"
        echo "===================================="
        
        # Configurar git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Cambiar a rama gh-pages
        git checkout gh-pages
        
        # Copiar archivos de resultados
        cp totales_reales_cloud_*.json . 2>/dev/null || true
        
        # Crear archivo de resumen para el dashboard
        LATEST_FILE=$(ls -t totales_reales_cloud_*.json | head -n 1)
        if [ -f "$LATEST_FILE" ]; then
          echo "ğŸ“Š Creando resumen para dashboard..."
          
          # Crear archivo de resumen simplificado
          jq '{
            timestamp: .timestamp,
            total_general: .total_general,
            tribunales: .totales_por_tribunal,
            fuente: "API oficial PJUD desde GitHub Actions",
            ip_origen: .ip_origen
          }' "$LATEST_FILE" > totales_reales_dashboard.json
          
          echo "âœ… Resumen creado: totales_reales_dashboard.json"
        fi
        
        # Commit y push
        git add .
        git commit -m "ğŸ“Š Actualizar totales reales del PJUD - $(date)" || echo "No hay cambios para commit"
        git push origin gh-pages
        
        echo "âœ… Resultados subidos a GitHub Pages"
        
    - name: ğŸ“Š Mostrar resumen final
      run: |
        echo ""
        echo "ğŸ‰ PROCESO COMPLETADO"
        echo "===================="
        echo "âœ… Totales reales obtenidos desde GitHub Actions"
        echo "âœ… Resultados subidos a GitHub Pages"
        echo "âœ… Dashboard actualizado con datos reales"
        echo ""
        echo "ğŸŒ Dashboard disponible en:"
        echo "https://ceo-exltk.github.io/descarga-sentencias-pjud/dashboard_tribunales_final.html"
        echo ""
        echo "ğŸ“Š Archivos generados:"
        ls -la totales_reales_*.json
